---
title: "Clustering Adult Heart Transplant Candidates"
author: "Will Parker, Lilly Reich"
subtitle: MACS 40800 group project
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_notebook:
    toc: yes
    toc_depth: 2
    toc_float: yes
---

#Overview: In the analysis, we computed a gower's distance and PAM clustering method to determine robustness for an adult heart transplant dataset. The purpose of utilizing PAM as a "k-finding" method is to seek variation (pairwise minimization dissimiliarties) for each clinical variable. 

```{r global_options, include = FALSE}
library(knitr)

#set global options for this rmarkdown document
opts_chunk$set(cache = TRUE, warning=FALSE, message=FALSE, tidy.opts=list(width.cutoff=60), echo = FALSE)
```

# Packages used
```{r packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(cluster)
library(Rtsne)
library(seriation)
```


# Variable Selection



## Load data in 
```{r main_dataset}
to_cluster <- read.csv("cleaned_heart_cans_2000_2017.csv")
```


## Feature selection and random sub-sample

We select only complete cases for now. We will always ignore the `PX_ID` variable when computing the distance matrix, it's just a meaningless patient ID variable. We will also ignore `status` during this first iteration, see if we can re-create the status groups with the clusters. We restrict the variables to clinical data (age, sex, bmi, diagnosis, comorbidities, functional status, hemodynamics, and treatments), removing socioeconomic variables like race and insurance status.
```{r load_data_in_subsample}

set.seed(1235)

df <- to_cluster %>%
  filter(status != "Inactive") %>%
  select(status,
         age,
    simple_diagnosis, 
         eGFR, diabetes, functional_status, 
         cardiac_index,pcwp) %>%
  na.omit() %>%
  sample_n(1000)


names(df)
```

# Compute Gower's Distance Matrix


```{r compute_gower}

gower_dist <- daisy(df %>% select(-status), metric = "gower")

gower_mat <- as.matrix(gower_dist)

gower_dist_object <- as.dist(gower_mat)
```

## most similar candidates
```{r most_similar}
df[which(gower_mat == min(gower_mat[gower_mat != min(gower_mat)]), arr.ind = TRUE)[1, ], ]
```
These two women are the same age and identical on almost all covariates, except for cardiac index.

## most dissimlar candidates
```{r most_dis}
df[which(gower_mat == max(gower_mat[gower_mat != max(gower_mat)]), arr.ind = TRUE)[1, ], ]
```


#Diagnose Clusterability

## ODI plot

Using Gower's distance matrix
```{r ODI}
dissplot(gower_dist_object)

ggsave("Figure_1_ODI.pdf")
```

From the ODI plot, there seem to be at least 3 clusters


# K finding for PAM clustering

We chose PAM because...

## Silhoutette Width
```{r sil_width}
sil_width <- c(NA)
for(i in 2:15){  
  pam_fit <- pam(gower_dist, diss = TRUE, k = i)  
  sil_width[i] <- pam_fit$silinfo$avg.width  
}
plot(1:15, sil_width,
     xlab = "Number of clusters",
     ylab = "Silhouette Width")
lines(1:15, sil_width)

ggsave("Figure_2_average_silhouette_by_cluster_number.pdf")
```

Looks like k = 3 would be reasonable


```{r elbow}
## Elbow Method
# k.max <- 15
# df <- df_data
# wss <- sapply(1:k.max, 
#               function(k){kmeans(df, k, nstart=50,iter.max = 15 )$tot.withinss})
# wss
# plot(1:k.max, wss,
#      type="b", pch = 19, frame = FALSE, 
#      xlab="Number of clusters K",
#      ylab="Total within-clusters sum of squares")
```

# Cluster results

For our preliminary number of clusters, we chose k =4 because there are actually 4 "Status groups" in the original data. These status levels determine the patients priority for transplantation.

```{r PAM}
k <- 3

pam_fit <- pam(gower_dist, diss = TRUE, k)


pam_results <- df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  do(the_summary = summary(.))

pam_results$the_summary
```

## Table 1: Means of continuous variables by cluster


Interestingly, cluster 2 has lower cardiac index and higher pulmonary capillary wedge pressure, suggesting worse cardiac physiology.
```{r means_by_cluster}
knitr::kable(df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  summarise_if(is.numeric, mean))
```





## Table 2: Distribution of functional status by cluster

Functional status is also dependent on cluster, with cluster 3 has the worse functional status (severe impairment)
```{r count_by_cluster}
total_obs <- df %>% nrow()

knitr::kable(df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  count(functional_status) %>%
  mutate(total = sum(n),
         pct = paste0(round(100*n/total), "%")) %>%
  select(functional_status, cluster, pct) %>%
  pivot_wider(names_from = "functional_status", values_from = "pct"))
```

# Dimension-reduction

Perform dimension reduction with `Rtsne` and plot results
```{r dim_reduction_with_t_SNE}
tsne_obj <- Rtsne(gower_dist, is_distance = TRUE)

tsne_data <- tsne_obj$Y %>%
  data.frame() %>%
  setNames(c("X", "Y")) %>%
  mutate(cluster = factor(pam_fit$clustering))

ggplot(aes(x = X, y = Y), data = tsne_data) +
  geom_point(aes(color = cluster))
```
Looks like in the 2-dimensional embedding generated by `Rtsne` the observations are  clumped, likely from our many categorical variables. within each data clump however, each is usually the same cluster.

```{r}
df_data <- df %>%
  mutate(cluster = factor(pam_fit$clustering))

ggplot(aes(x = age, y = eGFR), data = df_data) +
  geom_point(aes(color = cluster))
```
Picking two continuous variables, `age` and `eGFR` there doesn't seem to be any obvious relationship between the clusters and the 


# Table 3:Listing Status and clusters 
```{r status_cluster}

knitr::kable(df_data %>%
  group_by(status) %>%
  count(cluster) %>% 
  mutate(total = sum(n),
         pct = paste0(round(100*n/total), "%")) %>%
  select(status, cluster, pct) %>%
  pivot_wider(names_from = "status", values_from = "pct"))
```
Cluster 3 has a higher percentage of Status 1A candidates, however all Status levels are represented in each cluster.


# Next steps

## Importance of each clinical variable 

In our choice of distance metric, we assign equal weight to each clinical variable. We also selected a small subset of the variables based on clinical intuition. Does this make sense? Some clinical variables are clearly more important than others.


## GMM (Gaussian Mixture Model)


## Aim 2: survival analysis

Compare performance of clusters in predicting survival on waitlist with the "Status levels"
