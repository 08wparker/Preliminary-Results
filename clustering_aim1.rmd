---
title: "Clustering Adult Heart Transplant Candidates"
subtitle: MACS 40800 group project
author: Will Parker, Lilly Reich
output: 
  html_notebook:
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Packages used
```{r packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(cluster)
library(Rtsne)
```


# Load data in and select a random sub-sample

We select only complete cases for now.
```{r load_data_in_subsample}
to_cluster <- read.csv(file.choose())

set.seed(1235)

df <- to_cluster %>%
  na.omit() %>%
  sample_n(1000)

```

# Compute Gower's Distance Matrix

We will always ignore the `PX_ID` variable when computing the distance matrix, it's just a meaningless patient ID variable. We will also ignore `status` during this first iteration, see if we can re-create the status groups with the clusters
```{r compute_gower}

gower_dist <- daisy(df %>% 
                      select(-PX_ID, -status), metric = "gower")

gower_mat <- as.matrix(gower_dist)

```

## most similar candidates
```{r most_similar}
df[which(gower_mat == min(gower_mat[gower_mat != min(gower_mat)]), arr.ind = TRUE)[1, ], ]
```
These two women are the same age and identical on almost all covariates, except for cardiac index.

## most dissimlar candidates
```{r most_dis}
df[which(gower_mat == max(gower_mat[gower_mat != max(gower_mat)]), arr.ind = TRUE)[1, ], ]
```

# K finding for PAM clustering

We chose PAM because...

## Silhoutette Width
```{r sil_width}
sil_width <- c(NA)
for(i in 2:15){  
  pam_fit <- pam(gower_dist, diss = TRUE, k = i)  
  sil_width[i] <- pam_fit$silinfo$avg.width  
}
plot(1:15, sil_width,
     xlab = "Number of clusters",
     ylab = "Silhouette Width")
lines(1:15, sil_width)
```

Looks like k = 2 or k = 5 would be reasonable. Doesn't look like the mean varies too much though on the silhoutte "scale" (from 0.085 to 0.1) 


# Cluster results

For our preliminary number of clusters, we chose k =4 because there are actually 4 "Status groups" in the original data. These status levels determine the patients priority for transplantation.

```{r PAM}
k <- 4

pam_fit <- pam(gower_dist, diss = TRUE, k)


pam_results <- df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  do(the_summary = summary(.))

pam_results$the_summary
```

## Means of continuous variables by cluster
```{r means_by_cluster}
df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  select(-PX_ID) %>%
  summarise_if(is.numeric, mean)
```

## counts of categorical variables by cluster

Trying to figure out how to do this for all factor variables with dpylr, maybe a for loop is easiest
```{r count_by_cluster}

total_obs <- df %>% nrow()

df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  count(functional_status) %>%
  mutate(total = sum(n),
         pct = paste0(round(100*n/total), "%")) %>%
  select(functional_status, cluster, pct) %>%
  pivot_wider(names_from = "functional_status", values_from = "pct")
```
Functional status appears fairly evenly distributed across the clusters, although cluster 1 has the highest proportion of "Severe Impairment"

# Dimension-reduction

Perform dimension reduction with `Rtsne` and plot results
```{r dim_reduction_with_t_SNE}
tsne_obj <- Rtsne(gower_dist, is_distance = TRUE)

tsne_data <- tsne_obj$Y %>%
  data.frame() %>%
  setNames(c("X", "Y")) %>%
  mutate(cluster = factor(pam_fit$clustering))

ggplot(aes(x = X, y = Y), data = tsne_data) +
  geom_point(aes(color = cluster))
```
Looks like in the 2-dimensional embedding generated by `Rtsne` the observations are somewhat clustered

```{r}
df_data <- df %>%
  mutate(cluster = factor(pam_fit$clustering))

ggplot(aes(x = bmi, y = eGFR), data = df_data) +
  geom_point(aes(color = cluster))
```
Picking two continuous variables, `age` and `bmi` there doesn't seem to be any obvious relationship between the clusters and the 


# Listing Status and clusters 
```{r status_cluster}

df_data %>%
  group_by(status) %>%
  count(cluster) %>% 
  mutate(total = sum(n),
         pct = paste0(round(100*n/total), "%")) %>%
  select(status, cluster, pct) %>%
  pivot_wider(names_from = "status", values_from = "pct")
```
Looks like the clustering doesn't line up well with the candidate's inital Status that well!



# Next steps

## Importance of each clinical variable 

In our choice of distance metric, we assign equal weight to each clinical variable. Does this make sense? Some clinical variables are clearly more important than others.
